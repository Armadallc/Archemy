# Render.com Deployment Guide

## Overview

This guide covers deploying HALCYON TMS to Render.com, including both the frontend and backend services.

## Prerequisites

- Render.com account (sign up at https://render.com)
- GitHub repository connected to Render
- Supabase credentials (already configured)

## Architecture

- **Backend Service**: Node.js/Express API with WebSocket support
- **Frontend Service**: React/Vite static site
- **Database**: Supabase (external)

## Quick Start

### Option 1: Using `render.yaml` (Recommended)

1. **Connect Repository**
   - Go to Render Dashboard → New → Blueprint
   - Connect your GitHub repository
   - Render will detect `render.yaml` and create services automatically

2. **Set Environment Variables**
   - Backend Service → Environment:
     - `SUPABASE_URL`: Your Supabase project URL
     - `SUPABASE_ANON_KEY`: Your Supabase anon key
     - `SUPABASE_SERVICE_ROLE_KEY`: Your Supabase service role key
     - `SESSION_SECRET`: Auto-generated by Render (or set manually)
   - Frontend Service → Environment:
     - `VITE_SUPABASE_URL`: Your Supabase project URL
     - `VITE_SUPABASE_ANON_KEY`: Your Supabase anon key
     - `VITE_API_URL`: Auto-set from backend service

3. **Deploy**
   - Render will automatically deploy both services
   - Backend deploys first, then frontend

### Option 2: Manual Setup

#### Backend Service

1. **Create Web Service**
   - Render Dashboard → New → Web Service
   - Connect GitHub repository
   - Settings:
     - **Name**: `halcyon-backend`
     - **Environment**: Node
     - **Region**: Oregon (or closest to you)
     - **Branch**: `main` (or your deployment branch)
     - **Root Directory**: Leave empty (root)
     - **Build Command**: `npm install`
     - **Start Command**: `npx tsx server/index.ts`

2. **Environment Variables**
   ```
   NODE_ENV=production
   PORT=10000
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   SESSION_SECRET=your-session-secret
   ```

3. **Health Check**
   - Path: `/api/health`
   - Render will use this to verify service health

#### Frontend Service

1. **Create Static Site**
   - Render Dashboard → New → Static Site
   - Connect GitHub repository
   - Settings:
     - **Name**: `halcyon-frontend`
     - **Branch**: `main` (or your deployment branch)
     - **Root Directory**: `client`
     - **Build Command**: `npm install && npm run build`
     - **Publish Directory**: `dist`

2. **Environment Variables**
   ```
   VITE_API_URL=https://halcyon-backend.onrender.com
   VITE_SUPABASE_URL=https://your-project.supabase.co
   VITE_SUPABASE_ANON_KEY=your-anon-key
   ```

3. **SPA Routing**
   - Add rewrite rule: `/*` → `/index.html`
   - This ensures React Router works correctly

## Service URLs

After deployment:
- **Backend**: `https://halcyon-backend.onrender.com`
- **Frontend**: `https://halcyon-frontend.onrender.com`

## Environment Variables Reference

### Backend Service

| Variable | Required | Description |
|----------|----------|-------------|
| `NODE_ENV` | Yes | Set to `production` |
| `PORT` | Auto | Render sets this automatically |
| `SUPABASE_URL` | Yes | Your Supabase project URL |
| `SUPABASE_ANON_KEY` | Yes | Supabase anonymous key |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes | Supabase service role key |
| `SESSION_SECRET` | Yes | Secret for session encryption |

### Frontend Service

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_API_URL` | Yes | Backend service URL |
| `VITE_SUPABASE_URL` | Yes | Supabase project URL |
| `VITE_SUPABASE_ANON_KEY` | Yes | Supabase anonymous key |

## WebSocket Support

Render supports WebSocket connections. The backend WebSocket server runs on the same port as the HTTP server:
- WebSocket URL: `wss://halcyon-backend.onrender.com/ws`

## Free Tier Limitations

- **Spins down after 15 minutes of inactivity**
- **Cold start**: ~30-60 seconds after spin-down
- **750 hours/month free** (enough for development)
- **512 MB RAM** per service

## Upgrading to Paid Tier

For production, consider upgrading:
- **Starter Plan**: $7/month per service
  - Always-on (no spin-down)
  - Faster cold starts
  - More resources

## Troubleshooting

### Backend Not Starting

1. Check logs in Render Dashboard
2. Verify environment variables are set
3. Check that `PORT` is being used correctly
4. Verify Supabase credentials

### CORS Errors

1. Ensure backend CORS includes `*.onrender.com`
2. Check that `VITE_API_URL` points to correct backend URL
3. Verify both services are deployed

### WebSocket Not Connecting

1. Ensure backend is running (not spun down)
2. Check WebSocket URL uses `wss://` (secure)
3. Verify WebSocket path is `/ws`

### Frontend Build Fails

1. Check build logs for errors
2. Verify `client/package.json` has all dependencies
3. Ensure `dist` directory is created after build

## Custom Domain

To use a custom domain:

1. **Backend**: Settings → Custom Domain → Add domain
2. **Frontend**: Settings → Custom Domain → Add domain
3. Update DNS records as instructed
4. Update `VITE_API_URL` to use custom domain

## Continuous Deployment

Render automatically deploys on:
- Push to connected branch (usually `main`)
- Manual redeploy from dashboard

To disable auto-deploy:
- Service Settings → Auto-Deploy → Disable

## Monitoring

- **Logs**: Available in real-time in Render Dashboard
- **Metrics**: Basic metrics available on free tier
- **Alerts**: Configure in service settings

## Backup & Recovery

- **Environment Variables**: Export from Render Dashboard
- **Code**: Backed up in GitHub
- **Database**: Supabase handles backups

---

**Next Steps:**
- See `RENDER_MIGRATION.md` for migrating from Railway/Vercel
- See `RENDER_TROUBLESHOOTING.md` for common issues

