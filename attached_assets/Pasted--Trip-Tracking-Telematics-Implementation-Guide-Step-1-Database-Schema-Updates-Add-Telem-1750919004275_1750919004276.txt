# Trip Tracking & Telematics Implementation Guide

## Step 1: Database Schema Updates

### Add Telematics Fields to Trips Table

```sql
-- Run in Supabase SQL Editor
ALTER TABLE trips ADD COLUMN IF NOT EXISTS start_latitude DECIMAL(10,8);
ALTER TABLE trips ADD COLUMN IF NOT EXISTS start_longitude DECIMAL(11,8);
ALTER TABLE trips ADD COLUMN IF NOT EXISTS end_latitude DECIMAL(10,8);
ALTER TABLE trips ADD COLUMN IF NOT EXISTS end_longitude DECIMAL(11,8);
ALTER TABLE trips ADD COLUMN IF NOT EXISTS distance_miles DECIMAL(8,2);
ALTER TABLE trips ADD COLUMN IF NOT EXISTS fuel_cost DECIMAL(8,2);
ALTER TABLE trips ADD COLUMN IF NOT EXISTS driver_notes TEXT;

-- Add vehicle tracking fields
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS odometer_reading INTEGER;
ALTER TABLE vehicles ADD COLUMN IF NOT EXISTS mpg_rating DECIMAL(4,1);
```

## Step 2: Create Distance Calculation Utility

### Create `utils/distance.js`

```javascript
// Haversine formula for calculating distance between two points
export function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 3959; // Earth's radius in miles
  
  const dLat = toRadians(lat2 - lat1);
  const dLon = toRadians(lon2 - lon1);
  
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c;
  
  return Math.round(distance * 100) / 100; // Round to 2 decimal places
}

function toRadians(degrees) {
  return degrees * (Math.PI / 180);
}

// Get current location
export function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation not supported'));
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      position => {
        resolve({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy
        });
      },
      error => reject(error),
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 60000
      }
    );
  });
}
```

## Step 3: Trip Tracking Functions

### Create `services/tripTracking.js`

```javascript
import { supabase } from '../lib/supabase';
import { calculateDistance, getCurrentLocation } from '../utils/distance';

export class TripTracker {
  
  // Start trip tracking
  static async startTrip(tripId) {
    try {
      const location = await getCurrentLocation();
      
      const { data, error } = await supabase
        .from('trips')
        .update({
          start_latitude: location.lat,
          start_longitude: location.lng,
          actual_pickup_time: new Date().toISOString(),
          status: 'in_progress'
        })
        .eq('id', tripId)
        .select();
      
      if (error) throw error;
      
      console.log('Trip started:', data);
      return data[0];
      
    } catch (error) {
      console.error('Error starting trip:', error);
      throw error;
    }
  }
  
  // Complete trip tracking
  static async completeTrip(tripId, fuelCost = null, driverNotes = '') {
    try {
      // Get trip data to calculate distance
      const { data: tripData, error: fetchError } = await supabase
        .from('trips')
        .select('start_latitude, start_longitude')
        .eq('id', tripId)
        .single();
      
      if (fetchError) throw fetchError;
      
      const endLocation = await getCurrentLocation();
      let distance = null;
      
      // Calculate distance if we have start coordinates
      if (tripData.start_latitude && tripData.start_longitude) {
        distance = calculateDistance(
          tripData.start_latitude,
          tripData.start_longitude,
          endLocation.lat,
          endLocation.lng
        );
      }
      
      const updateData = {
        end_latitude: endLocation.lat,
        end_longitude: endLocation.lng,
        actual_dropoff_time: new Date().toISOString(),
        status: 'completed',
        driver_notes: driverNotes
      };
      
      if (distance) updateData.distance_miles = distance;
      if (fuelCost) updateData.fuel_cost = fuelCost;
      
      const { data, error } = await supabase
        .from('trips')
        .update(updateData)
        .eq('id', tripId)
        .select();
      
      if (error) throw error;
      
      console.log('Trip completed:', data);
      return data[0];
      
    } catch (error) {
      console.error('Error completing trip:', error);
      throw error;
    }
  }
  
  // Open native map app for navigation
  static openMapApp(destinationAddress) {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    if (isIOS) {
      // Open Apple Maps
      window.open(`maps://?daddr=${encodeURIComponent(destinationAddress)}`);
    } else if (isAndroid) {
      // Open Google Maps
      window.open(`geo:0,0?q=${encodeURIComponent(destinationAddress)}`);
    } else {
      // Fallback to web Google Maps
      window.open(`https://maps.google.com/maps?daddr=${encodeURIComponent(destinationAddress)}`);
    }
  }
}
```

## Step 4: Trip Component Updates

### Update Trip Card Component

```jsx
import React, { useState } from 'react';
import { TripTracker } from '../services/tripTracking';

export function TripCard({ trip, onTripUpdate }) {
  const [isLoading, setIsLoading] = useState(false);
  const [fuelCost, setFuelCost] = useState('');
  const [driverNotes, setDriverNotes] = useState('');

  const handleStartTrip = async () => {
    setIsLoading(true);
    try {
      const updatedTrip = await TripTracker.startTrip(trip.id);
      onTripUpdate(updatedTrip);
      
      // Open navigation
      TripTracker.openMapApp(trip.pickup_address);
    } catch (error) {
      alert('Error starting trip: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const handleCompleteTrip = async () => {
    setIsLoading(true);
    try {
      const updatedTrip = await TripTracker.completeTrip(
        trip.id, 
        fuelCost ? parseFloat(fuelCost) : null,
        driverNotes
      );
      onTripUpdate(updatedTrip);
    } catch (error) {
      alert('Error completing trip: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="trip-card">
      <h3>{trip.pickup_address} → {trip.dropoff_address}</h3>
      <p>Passengers: {trip.passenger_count}</p>
      <p>Status: {trip.status}</p>
      
      {trip.distance_miles && (
        <p>Distance: {trip.distance_miles} miles</p>
      )}
      
      {trip.status === 'scheduled' && (
        <button 
          onClick={handleStartTrip} 
          disabled={isLoading}
          className="btn-start-trip"
        >
          {isLoading ? 'Starting...' : 'Start Trip'}
        </button>
      )}
      
      {trip.status === 'in_progress' && (
        <div className="trip-completion">
          <input
            type="number"
            step="0.01"
            placeholder="Fuel cost (optional)"
            value={fuelCost}
            onChange={e => setFuelCost(e.target.value)}
          />
          <textarea
            placeholder="Driver notes (optional)"
            value={driverNotes}
            onChange={e => setDriverNotes(e.target.value)}
          />
          <button 
            onClick={handleCompleteTrip} 
            disabled={isLoading}
            className="btn-complete-trip"
          >
            {isLoading ? 'Completing...' : 'Complete Trip'}
          </button>
        </div>
      )}
    </div>
  );
}
```

## Step 5: Monthly Reports Query

### Create `services/reports.js`

```javascript
import { supabase } from '../lib/supabase';

export class Reports {
  
  // Get monthly metrics for organization
  static async getMonthlyMetrics(organizationId, year, month) {
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);
    
    const { data, error } = await supabase
      .from('trips')
      .select(`
        id,
        driver_id,
        passenger_count,
        distance_miles,
        fuel_cost,
        actual_pickup_time,
        drivers(id, user_id)
      `)
      .eq('organization_id', organizationId)
      .gte('actual_pickup_time', startDate.toISOString())
      .lte('actual_pickup_time', endDate.toISOString())
      .not('actual_pickup_time', 'is', null);
    
    if (error) throw error;
    
    // Aggregate metrics
    const metrics = {
      totalTrips: data.length,
      totalPassengers: data.reduce((sum, trip) => sum + (trip.passenger_count || 0), 0),
      totalMiles: data.reduce((sum, trip) => sum + (trip.distance_miles || 0), 0),
      totalFuelCost: data.reduce((sum, trip) => sum + (trip.fuel_cost || 0), 0),
      driverBreakdown: {}
    };
    
    // Group by driver
    data.forEach(trip => {
      const driverId = trip.driver_id || 'unassigned';
      if (!metrics.driverBreakdown[driverId]) {
        metrics.driverBreakdown[driverId] = {
          trips: 0,
          passengers: 0,
          miles: 0,
          fuelCost: 0
        };
      }
      metrics.driverBreakdown[driverId].trips++;
      metrics.driverBreakdown[driverId].passengers += trip.passenger_count || 0;
      metrics.driverBreakdown[driverId].miles += trip.distance_miles || 0;
      metrics.driverBreakdown[driverId].fuelCost += trip.fuel_cost || 0;
    });
    
    return metrics;
  }
}
```

## Step 6: Testing & Implementation

### Test the Implementation

1. **Run database migrations** in Supabase
1. **Create a test trip** and assign it to a driver
1. **Test location permissions** - ensure browser allows geolocation
1. **Start trip** - verify coordinates are captured
1. **Complete trip** - verify distance calculation
1. **Check reports** - verify monthly aggregation works

### Key Features Implemented

- ✅ **Free geolocation tracking** using browser APIs
- ✅ **Distance calculation** without external APIs
- ✅ **Native map integration** (Apple Maps/Google Maps)
- ✅ **Simple fuel cost tracking**
- ✅ **Monthly reporting** with aggregated metrics
- ✅ **Driver notes** for trip details

### Next Steps

- Add **offline tracking** capability
- Implement **route optimization**
- Add **driver performance analytics**
- Create **automated reports** and notifications