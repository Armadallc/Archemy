<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Functionality Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Export Functionality Test</h1>
        <p>This page tests the export functionality implemented in the HALCYON NMT system.</p>

        <div class="test-section">
            <h3>üìä Test Data</h3>
            <p>Sample data for testing export functionality:</p>
            <pre id="sampleData"></pre>
        </div>

        <div class="test-section">
            <h3>üìÑ Export Tests</h3>
            <button onclick="testCSVExport()">Test CSV Export</button>
            <button onclick="testJSONExport()">Test JSON Export</button>
            <button onclick="testTripReport()">Test Trip Report</button>
            <button onclick="testDriverReport()">Test Driver Report</button>
            <button onclick="testClientReport()">Test Client Report</button>
            <button onclick="testFinancialReport()">Test Financial Report</button>
        </div>

        <div class="test-section">
            <h3>üìà Export Statistics</h3>
            <div id="stats"></div>
        </div>

        <div class="test-section">
            <h3>üìÅ Generated Files</h3>
            <div id="files"></div>
        </div>

        <div class="test-section">
            <h3>üîç Test Results</h3>
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Sample data for testing
        const sampleTrips = [
            {
                id: '1',
                client: { first_name: 'John', last_name: 'Doe' },
                pickup_address: '123 Main St',
                dropoff_address: '456 Oak Ave',
                scheduled_pickup_time: '2025-01-15T10:00:00Z',
                actual_pickup_time: '2025-01-15T10:05:00Z',
                status: 'completed',
                driver: { license_number: 'DL123456' },
                program: { name: 'Test Program' },
                corporate_client: { name: 'Test Corp' },
                created_at: '2025-01-01T00:00:00Z'
            },
            {
                id: '2',
                client: { first_name: 'Jane', last_name: 'Smith' },
                pickup_address: '789 Pine St',
                dropoff_address: '321 Elm St',
                scheduled_pickup_time: '2025-01-16T14:00:00Z',
                actual_pickup_time: null,
                status: 'scheduled',
                driver: { license_number: 'DL789012' },
                program: { name: 'Test Program' },
                corporate_client: { name: 'Test Corp' },
                created_at: '2025-01-02T00:00:00Z'
            }
        ];

        const sampleDrivers = [
            {
                id: '1',
                first_name: 'Alice',
                last_name: 'Johnson',
                email: 'alice@example.com',
                phone: '555-0123',
                license_number: 'DL123456',
                license_expiry: '2026-12-31',
                vehicle_info: 'Toyota Camry 2020',
                is_active: true,
                is_available: true,
                created_at: '2025-01-01T00:00:00Z'
            },
            {
                id: '2',
                first_name: 'Bob',
                last_name: 'Wilson',
                email: 'bob@example.com',
                phone: '555-0456',
                license_number: 'DL789012',
                license_expiry: '2025-06-30',
                vehicle_info: 'Honda Accord 2019',
                is_active: true,
                is_available: false,
                created_at: '2025-01-02T00:00:00Z'
            }
        ];

        const sampleClients = [
            {
                id: '1',
                first_name: 'John',
                last_name: 'Doe',
                email: 'john@example.com',
                phone: '555-0789',
                address: '123 Main St, City, State',
                is_active: true,
                emergency_contact_name: 'Jane Doe',
                emergency_contact_phone: '555-0987',
                created_at: '2025-01-01T00:00:00Z'
            },
            {
                id: '2',
                first_name: 'Jane',
                last_name: 'Smith',
                email: 'jane@example.com',
                phone: '555-0321',
                address: '456 Oak Ave, City, State',
                is_active: true,
                emergency_contact_name: 'John Smith',
                emergency_contact_phone: '555-0654',
                created_at: '2025-01-02T00:00:00Z'
            }
        ];

        // Export Service Implementation
        class ExportService {
            static exportToCSV(data, columns, options = {}) {
                const { filename = 'export.csv', includeHeaders = true, delimiter = ',' } = options;
                
                if (data.length === 0) {
                    console.warn('No data to export');
                    return;
                }

                let csvContent = '';

                if (includeHeaders) {
                    const headers = columns.map(col => this.escapeCSVValue(col.label)).join(delimiter);
                    csvContent += headers + '\n';
                }

                data.forEach((item) => {
                    const row = columns.map(col => {
                        const value = item[col.key];
                        const formattedValue = col.formatter ? col.formatter(item) : String(value || '');
                        return this.escapeCSVValue(formattedValue);
                    }).join(delimiter);
                    csvContent += row + '\n';
                });

                this.downloadFile(csvContent, filename, 'text/csv');
            }

            static exportToJSON(data, options = {}) {
                const { filename = 'export.json' } = options;
                const jsonContent = JSON.stringify(data, null, 2);
                this.downloadFile(jsonContent, filename, 'application/json');
            }

            static exportTripReport(trips, options = {}) {
                const columns = [
                    { key: 'id', label: 'Trip ID' },
                    { key: 'client_name', label: 'Client Name', formatter: (trip) => `${trip.client?.first_name || ''} ${trip.client?.last_name || ''}`.trim() },
                    { key: 'pickup_address', label: 'Pickup Address' },
                    { key: 'dropoff_address', label: 'Dropoff Address' },
                    { key: 'scheduled_pickup_time', label: 'Scheduled Pickup', formatter: (trip) => trip.scheduled_pickup_time ? new Date(trip.scheduled_pickup_time).toLocaleString() : '' },
                    { key: 'actual_pickup_time', label: 'Actual Pickup', formatter: (trip) => trip.actual_pickup_time ? new Date(trip.actual_pickup_time).toLocaleString() : '' },
                    { key: 'status', label: 'Status' },
                    { key: 'driver_name', label: 'Driver', formatter: (trip) => trip.driver?.license_number || 'Unassigned' },
                    { key: 'program_name', label: 'Program', formatter: (trip) => trip.program?.name || 'Unknown' },
                    { key: 'corporate_client_name', label: 'Corporate Client', formatter: (trip) => trip.corporate_client?.name || 'N/A' },
                    { key: 'created_at', label: 'Created', formatter: (trip) => trip.created_at ? new Date(trip.created_at).toLocaleDateString() : '' }
                ];

                this.exportToCSV(trips, columns, {
                    filename: options.filename || `trip-report-${new Date().toISOString().split('T')[0]}.csv`
                });
            }

            static exportDriverReport(drivers, options = {}) {
                const columns = [
                    { key: 'id', label: 'Driver ID' },
                    { key: 'name', label: 'Name', formatter: (driver) => `${driver.first_name} ${driver.last_name}` },
                    { key: 'email', label: 'Email' },
                    { key: 'phone', label: 'Phone' },
                    { key: 'license_number', label: 'License Number' },
                    { key: 'license_expiry', label: 'License Expiry', formatter: (driver) => driver.license_expiry ? new Date(driver.license_expiry).toLocaleDateString() : 'N/A' },
                    { key: 'vehicle_info', label: 'Vehicle Info' },
                    { key: 'is_active', label: 'Status', formatter: (driver) => driver.is_active ? 'Active' : 'Inactive' },
                    { key: 'is_available', label: 'Available', formatter: (driver) => driver.is_available ? 'Yes' : 'No' },
                    { key: 'created_at', label: 'Created', formatter: (driver) => driver.created_at ? new Date(driver.created_at).toLocaleDateString() : '' }
                ];

                this.exportToCSV(drivers, columns, {
                    filename: options.filename || `driver-report-${new Date().toISOString().split('T')[0]}.csv`
                });
            }

            static exportClientReport(clients, options = {}) {
                const columns = [
                    { key: 'id', label: 'Client ID' },
                    { key: 'name', label: 'Name', formatter: (client) => `${client.first_name} ${client.last_name}` },
                    { key: 'email', label: 'Email' },
                    { key: 'phone', label: 'Phone' },
                    { key: 'address', label: 'Address' },
                    { key: 'is_active', label: 'Status', formatter: (client) => client.is_active ? 'Active' : 'Inactive' },
                    { key: 'emergency_contact_name', label: 'Emergency Contact' },
                    { key: 'emergency_contact_phone', label: 'Emergency Phone' },
                    { key: 'created_at', label: 'Created', formatter: (client) => client.created_at ? new Date(client.created_at).toLocaleDateString() : '' }
                ];

                this.exportToCSV(clients, columns, {
                    filename: options.filename || `client-report-${new Date().toISOString().split('T')[0]}.csv`
                });
            }

            static exportFinancialReport(trips, options = {}) {
                const columns = [
                    { key: 'id', label: 'Trip ID' },
                    { key: 'client_name', label: 'Client', formatter: (trip) => `${trip.client?.first_name || ''} ${trip.client?.last_name || ''}`.trim() },
                    { key: 'scheduled_pickup_time', label: 'Date', formatter: (trip) => trip.scheduled_pickup_time ? new Date(trip.scheduled_pickup_time).toLocaleDateString() : '' },
                    { key: 'distance_miles', label: 'Distance (miles)' },
                    { key: 'fuel_cost', label: 'Fuel Cost', formatter: (trip) => trip.fuel_cost ? `$${Number(trip.fuel_cost).toFixed(2)}` : '$0.00' },
                    { key: 'status', label: 'Status' },
                    { key: 'created_at', label: 'Created', formatter: (trip) => trip.created_at ? new Date(trip.created_at).toLocaleDateString() : '' }
                ];

                this.exportToCSV(trips, columns, {
                    filename: options.filename || `financial-report-${new Date().toISOString().split('T')[0]}.csv`
                });
            }

            static getExportStats(data) {
                const totalRecords = data.length;
                const avgRecordSize = 100;
                const totalSize = totalRecords * avgRecordSize;
                const exportSize = this.formatBytes(totalSize);
                const estimatedTime = totalRecords < 1000 ? '< 1 second' : 
                                     totalRecords < 10000 ? '1-3 seconds' : 
                                     '3-10 seconds';

                return {
                    totalRecords,
                    exportSize,
                    estimatedTime
                };
            }

            static formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            static escapeCSVValue(value) {
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }

            static downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }
        }

        // Test functions
        function testCSVExport() {
            try {
                ExportService.exportToCSV(sampleTrips, [
                    { key: 'id', label: 'Trip ID' },
                    { key: 'client_name', label: 'Client Name', formatter: (trip) => `${trip.client?.first_name || ''} ${trip.client?.last_name || ''}`.trim() },
                    { key: 'pickup_address', label: 'Pickup Address' },
                    { key: 'dropoff_address', label: 'Dropoff Address' },
                    { key: 'status', label: 'Status' }
                ], { filename: 'test-trips.csv' });
                logResult('CSV Export', 'success', 'Trip CSV export successful');
            } catch (error) {
                logResult('CSV Export', 'error', `CSV export failed: ${error.message}`);
            }
        }

        function testJSONExport() {
            try {
                ExportService.exportToJSON(sampleDrivers, { filename: 'test-drivers.json' });
                logResult('JSON Export', 'success', 'Driver JSON export successful');
            } catch (error) {
                logResult('JSON Export', 'error', `JSON export failed: ${error.message}`);
            }
        }

        function testTripReport() {
            try {
                ExportService.exportTripReport(sampleTrips, { filename: 'test-trip-report.csv' });
                logResult('Trip Report', 'success', 'Trip report export successful');
            } catch (error) {
                logResult('Trip Report', 'error', `Trip report export failed: ${error.message}`);
            }
        }

        function testDriverReport() {
            try {
                ExportService.exportDriverReport(sampleDrivers, { filename: 'test-driver-report.csv' });
                logResult('Driver Report', 'success', 'Driver report export successful');
            } catch (error) {
                logResult('Driver Report', 'error', `Driver report export failed: ${error.message}`);
            }
        }

        function testClientReport() {
            try {
                ExportService.exportClientReport(sampleClients, { filename: 'test-client-report.csv' });
                logResult('Client Report', 'success', 'Client report export successful');
            } catch (error) {
                logResult('Client Report', 'error', `Client report export failed: ${error.message}`);
            }
        }

        function testFinancialReport() {
            try {
                ExportService.exportFinancialReport(sampleTrips, { filename: 'test-financial-report.csv' });
                logResult('Financial Report', 'success', 'Financial report export successful');
            } catch (error) {
                logResult('Financial Report', 'error', `Financial report export failed: ${error.message}`);
            }
        }

        function logResult(test, type, message) {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 'error';
            resultsDiv.innerHTML += `<div class="${className}">[${timestamp}] ${test}: ${message}</div>`;
        }

        function updateStats() {
            const statsDiv = document.getElementById('stats');
            const tripStats = ExportService.getExportStats(sampleTrips);
            const driverStats = ExportService.getExportStats(sampleDrivers);
            const clientStats = ExportService.getExportStats(sampleClients);

            statsDiv.innerHTML = `
                <div class="info">Trips: ${tripStats.totalRecords} records, ${tripStats.exportSize}, ${tripStats.estimatedTime}</div>
                <div class="info">Drivers: ${driverStats.totalRecords} records, ${driverStats.exportSize}, ${driverStats.estimatedTime}</div>
                <div class="info">Clients: ${clientStats.totalRecords} records, ${clientStats.exportSize}, ${clientStats.estimatedTime}</div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sampleData').textContent = JSON.stringify({
                trips: sampleTrips.length,
                drivers: sampleDrivers.length,
                clients: sampleClients.length
            }, null, 2);
            
            updateStats();
            
            logResult('System', 'info', 'Export functionality test page loaded successfully');
        });
    </script>
</body>
</html>







